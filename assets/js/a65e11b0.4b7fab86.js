(self.webpackChunkuniswap=self.webpackChunkuniswap||[]).push([[5007],{5079:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return i},contentTitle:function(){return c},metadata:function(){return s},toc:function(){return u},default:function(){return p}});var o=n(2122),a=n(9756),r=(n(7294),n(3905)),i={id:"creating-a-trade",title:"Creating a Trade"},c=void 0,s={unversionedId:"guides/creating-a-trade",id:"version-3.0.0/guides/creating-a-trade",isDocsHomePage:!1,title:"Creating a Trade",description:"This guide extends the previous creating a pool and getting started guides by using the pool object to quote an estimated amount out for a trade, then creates a trade object that can be used to execute a swap.",source:"@site/SDK_versioned_docs/version-3.0.0/guides/04-creating-a-trade.md",sourceDirName:"guides",slug:"/guides/creating-a-trade",permalink:"/sdk/guides/creating-a-trade",version:"3.0.0",sidebarPosition:4,frontMatter:{id:"creating-a-trade",title:"Creating a Trade"},sidebar:"version-V3/sdksidebar",previous:{title:"Removing Liquidity",permalink:"/sdk/guides/liquidity/removing"},next:{title:"Fetching Spot Prices",permalink:"/sdk/guides/fetching-prices"}},u=[{value:"Creating a Quoter Contract Object",id:"creating-a-quoter-contract-object",children:[]},{value:"Using callStatic To Return A Quote",id:"using-callstatic-to-return-a-quote",children:[]},{value:"Construct a Trade",id:"construct-a-trade",children:[]},{value:"Print The Quote And Trade To Your Console",id:"print-the-quote-and-trade-to-your-console",children:[]},{value:"The Full Example",id:"the-full-example",children:[]}],l={toc:u};function p(e){var t=e.components,n=(0,a.Z)(e,["components"]);return(0,r.kt)("wrapper",(0,o.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This guide extends the previous ",(0,r.kt)("a",{parentName:"p",href:"/sdk/guides/creating-a-pool"},"creating a pool")," and ",(0,r.kt)("a",{parentName:"p",href:"./using-ethers"},"getting started")," guides by using the ",(0,r.kt)("inlineCode",{parentName:"p"},"pool")," object to quote an estimated amount out for a trade, then creates a trade object that can be used to execute a swap."),(0,r.kt)("h2",{id:"creating-a-quoter-contract-object"},"Creating a Quoter Contract Object"),(0,r.kt)("p",null,"In order to retrieve a quote, create a ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ethers.io/v5/api/contract/contract/"},"Contract")," object using ethers.js"),(0,r.kt)("p",null,"The quoter is a smart contract that retrieves estimated output or input amounts for a given swap type. This example creates an object in our javascript environment that models the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/uniswap-v3-periphery-optimism/blob/69e095f7c28a7e7fdaca94b5eaa644a8a25f86cc/contracts/interfaces/IQuoter.sol"},"quoter interface"),", which can be called to return a swap quote."),(0,r.kt)("p",null,"Create the quoter contract object by importing the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.soliditylang.org/en/v0.7.0/abi-spec.html"},"ABI")," from the ",(0,r.kt)("a",{parentName:"p",href:"https://www.npmjs.com/package/@uniswap/v3-periphery"},"uniswap-v3-periphery")," npm package."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'import { abi as QuoterABI } from "@uniswap/v3-periphery/artifacts/contracts/lens/Quoter.sol/Quoter.json";\n')),(0,r.kt)("p",null,"assign your ",(0,r.kt)("a",{parentName:"p",href:"https://ethereum.org/en/developers/docs/nodes-and-clients/nodes-as-a-service/"},"ethereum endpoint provider"),", in this case, Infura."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'const provider = new ethers.providers.JsonRpcProvider("<YOUR-ENDPOINT-HERE>");\n')),(0,r.kt)("p",null,"Provide the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/uniswap-v3-periphery/blob/main/deploys.md"},"deployment address of the quoter contract"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const quoterContract = new ethers.Contract(quoterAddress, QuoterABI, provider);\n")),(0,r.kt)("h2",{id:"using-callstatic-to-return-a-quote"},"Using callStatic To Return A Quote"),(0,r.kt)("p",null,"To get a quote for a swap, we will call the Quoter contract's ",(0,r.kt)("inlineCode",{parentName:"p"},"quoteExactInputSingle")," function, the interface of which looks like this:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-solidity"},"   function quoteExactInputSingle(\n        address tokenIn,\n        address tokenOut,\n        uint24 fee,\n        uint256 amountIn,\n        uint160 sqrtPriceLimitX96\n    ) external returns (uint256 amountOut);\n")),(0,r.kt)("p",null,"In an ideal world, these quoter functions would be ",(0,r.kt)("inlineCode",{parentName:"p"},"view")," functions, which would make them very easy to query on-chain with minimal gas costs. Instead, the V3 quoter contracts rely on state-changing calls designed to be reverted to return the desired data. This means calling the quoter will be very expensive and should not be called on-chain."),(0,r.kt)("p",null,"To get around this difficulty, we can use the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.ethers.io/v5/api/contract/contract/#contract-callStatic"},"callStatic")," method provided by ",(0,r.kt)("inlineCode",{parentName:"p"},"ethers.js"),". ",(0,r.kt)("inlineCode",{parentName:"p"},"callStatic")," is a useful method that submits a state-changing transaction to an Ethereum node, but asks the node to simulate the state change, rather than to execute it. Our script can then return the result of the simulated state change."),(0,r.kt)("p",null,"To simulate a transaction without actually broadcasting it to the EVM, use the ",(0,r.kt)("inlineCode",{parentName:"p"},"callStatic")," to call the ",(0,r.kt)("inlineCode",{parentName:"p"},"ExactInputSingle")," function in the ",(0,r.kt)("inlineCode",{parentName:"p"},"Quoter")," contract, which will tell us how much an of output token we will receive given a certain amount of input token when using a single hop swap."),(0,r.kt)("p",null,"Note this function uses the ",(0,r.kt)("inlineCode",{parentName:"p"},"Immutables")," interface defined in the earlier guides."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"async function main() {\n  const amountIn = 1500;\n\n  const quotedAmountOut = await quoterContract.callStatic.quoteExactInputSingle(\n    immutables.token0,\n    immutables.token1,\n    immutables.fee,\n    amountIn.toString(),\n    0\n  );\n}\n")),(0,r.kt)("h2",{id:"construct-a-trade"},"Construct a Trade"),(0,r.kt)("p",null,"Create a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/uniswap-v3-sdk/blob/7c3aedd0cf9441d03607e258734eada44a73863d/src/entities/route.ts"},"Route")," object and assign it to a variable ",(0,r.kt)("inlineCode",{parentName:"p"},"swapRoute")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const swapRoute = new Route([poolExample], TokenA, TokenB);\n")),(0,r.kt)("p",null,"Create an ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/Uniswap/uniswap-v3-sdk/blob/7c3aedd0cf9441d03607e258734eada44a73863d/src/entities/trade.ts#L346"},"Unchecked Trade"),", a type of trade that is useful when we have retrieved a quote prior to the construction of the trade object."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const uncheckedTradeExample = await Trade.createUncheckedTrade({\n  route: swapRoute,\n  inputAmount: CurrencyAmount.fromRawAmount(TokenA, amountIn.toString()),\n  outputAmount: CurrencyAmount.fromRawAmount(\n    TokenB,\n    quotedAmountOut.toString()\n  ),\n  tradeType: TradeType.EXACT_INPUT,\n});\n")),(0,r.kt)("h2",{id:"print-the-quote-and-trade-to-your-console"},"Print The Quote And Trade To Your Console"),(0,r.kt)("p",null,"Print the ",(0,r.kt)("inlineCode",{parentName:"p"},"Quote")," and the ",(0,r.kt)("inlineCode",{parentName:"p"},"UncheckedTrade")," to the console."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'console.log("The quoted amount out is", quotedAmountOut.toString());\nconsole.log("The unchecked trade object is", uncheckedTradeExample);\n')),(0,r.kt)("p",null,"If everything is working, you should see something similar to this returned in your console."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-console"},"The quoted amount out is 661497830963\nThe unchecked trade object is Trade {\n  swaps: [\n    {\n      inputAmount: [CurrencyAmount],\n      outputAmount: [CurrencyAmount],\n      route: [Route]\n    }\n  ],\n  tradeType: 0\n}\n")),(0,r.kt)("h2",{id:"the-full-example"},"The Full Example"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'import { ethers } from "ethers";\nimport { Pool } from "@uniswap/v3-sdk";\nimport { CurrencyAmount, Token, TradeType } from "@uniswap/sdk-core";\nimport { abi as IUniswapV3PoolABI } from "@uniswap/v3-core/artifacts/contracts/interfaces/IUniswapV3Pool.sol/IUniswapV3Pool.json";\nimport { Route } from "@uniswap/v3-sdk";\nimport { Trade } from "@uniswap/v3-sdk";\nimport { abi as QuoterABI } from "@uniswap/v3-periphery/artifacts/contracts/lens/Quoter.sol/Quoter.json";\n\nconst provider = new ethers.providers.JsonRpcProvider("<YOUR-ENDPOINT-HERE>");\n\nconst poolAddress = "0xee815cdc6322031952a095c6cc6fed036cb1f70d";\n\nconst poolContract = new ethers.Contract(\n  poolAddress,\n  IUniswapV3PoolABI,\n  provider\n);\n\nconst quoterAddress = "0xb27308f9F90D607463bb33eA1BeBb41C27CE5AB6";\n\nconst quoterContract = new ethers.Contract(quoterAddress, QuoterABI, provider);\n\ninterface Immutables {\n  factory: string;\n  token0: string;\n  token1: string;\n  fee: number;\n  tickSpacing: number;\n  maxLiquidityPerTick: ethers.BigNumber;\n}\n\ninterface State {\n  liquidity: ethers.BigNumber;\n  sqrtPriceX96: ethers.BigNumber;\n  tick: number;\n  observationIndex: number;\n  observationCardinality: number;\n  observationCardinalityNext: number;\n  feeProtocol: number;\n  unlocked: boolean;\n}\n\nasync function getPoolImmutables() {\n  const [factory, token0, token1, fee, tickSpacing, maxLiquidityPerTick] =\n    await Promise.all([\n      poolContract.factory(),\n      poolContract.token0(),\n      poolContract.token1(),\n      poolContract.fee(),\n      poolContract.tickSpacing(),\n      poolContract.maxLiquidityPerTick(),\n    ]);\n\n  const immutables: Immutables = {\n    factory,\n    token0,\n    token1,\n    fee,\n    tickSpacing,\n    maxLiquidityPerTick,\n  };\n  return immutables;\n}\n\nasync function getPoolState() {\n  // note that data here can be desynced if the call executes over the span of two or more blocks.\n  const [liquidity, slot] = await Promise.all([\n    poolContract.liquidity(),\n    poolContract.slot0(),\n  ]);\n\n  const PoolState: State = {\n    liquidity,\n    sqrtPriceX96: slot[0],\n    tick: slot[1],\n    observationIndex: slot[2],\n    observationCardinality: slot[3],\n    observationCardinalityNext: slot[4],\n    feeProtocol: slot[5],\n    unlocked: slot[6],\n  };\n\n  return PoolState;\n}\n\nasync function main() {\n  // query the state and immutable variables of the pool\n  const [immutables, state] = await Promise.all([\n    getPoolImmutables(),\n    getPoolState(),\n  ]);\n\n  // create instances of the Token object to represent the two tokens in the given pool\n  const TokenA = new Token(3, immutables.token0, 6, "USDC", "USD Coin");\n\n  const TokenB = new Token(3, immutables.token1, 18, "WETH", "Wrapped Ether");\n\n  // create an instance of the pool object for the given pool\n  const poolExample = new Pool(\n    TokenA,\n    TokenB,\n    immutables.fee,\n    state.sqrtPriceX96.toString(), //note the description discrepancy - sqrtPriceX96 and sqrtRatioX96 are interchangable values\n    state.liquidity.toString(),\n    state.tick\n  );\n\n  // assign an input amount for the swap\n  const amountIn = 1500;\n\n  // call the quoter contract to determine the amount out of a swap, given an amount in\n  const quotedAmountOut = await quoterContract.callStatic.quoteExactInputSingle(\n    immutables.token0,\n    immutables.token1,\n    immutables.fee,\n    amountIn.toString(),\n    0\n  );\n\n  // create an instance of the route object in order to construct a trade object\n  const swapRoute = new Route([poolExample], TokenA, TokenB);\n\n  // create an unchecked trade instance\n  const uncheckedTradeExample = await Trade.createUncheckedTrade({\n    route: swapRoute,\n    inputAmount: CurrencyAmount.fromRawAmount(TokenA, amountIn.toString()),\n    outputAmount: CurrencyAmount.fromRawAmount(\n      TokenB,\n      quotedAmountOut.toString()\n    ),\n    tradeType: TradeType.EXACT_INPUT,\n  });\n\n  // print the quote and the unchecked trade instance in the console\n  console.log("The quoted amount out is", quotedAmountOut.toString());\n  console.log("The unchecked trade object is", uncheckedTradeExample);\n}\n\nmain();\n')))}p.isMDXComponent=!0},3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return l},kt:function(){return m}});var o=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=o.createContext({}),u=function(e){var t=o.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},l=function(e){var t=u(e.components);return o.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},d=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),d=u(n),m=a,h=d["".concat(s,".").concat(m)]||d[m]||p[m]||r;return n?o.createElement(h,i(i({ref:t},l),{},{components:n})):o.createElement(h,i({ref:t},l))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=d;var c={};for(var s in t)hasOwnProperty.call(t,s)&&(c[s]=t[s]);c.originalType=e,c.mdxType="string"==typeof e?e:a,i[1]=c;for(var u=2;u<r;u++)i[u]=n[u];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);